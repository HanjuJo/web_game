<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íƒ€ì´í•‘ ë§ˆìŠ¤í„°</title>
    <link rel="stylesheet" href="mobile-styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background-color: #20c997;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .home-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            color: white;
            cursor: pointer;
        }
        
        .container {
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            flex-grow: 1;
            padding: 20px;
        }
        
        .difficulty-container {
            text-align: center;
            margin-bottom: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .difficulty-btn {
            background-color: #20c997;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        
        .difficulty-btn:hover {
            background-color: #12b886;
        }
        
        .game-area {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .score-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .timer {
            color: #fa5252;
            font-weight: bold;
        }
        
        .text-display {
            background-color: #f1f3f5;
            padding: 20px;
            border-radius: 5px;
            font-size: 18px;
            line-height: 1.6;
            min-height: 100px;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        
        .highlight {
            background-color: #c3fae8;
        }
        
        .error {
            background-color: #ffe3e3;
            text-decoration: underline wavy #fa5252;
        }
        
        .completed {
            color: #adb5bd;
        }
        
        .text-input {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            resize: none;
            margin-bottom: 20px;
        }
        
        .btn {
            background-color: #20c997;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .btn:hover {
            background-color: #12b886;
        }
        
        .buttons {
            display: flex;
            justify-content: center;
        }
        
        .result-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none;
        }
        
        .result-title {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .result-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #20c997;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
        }
        
        footer {
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }
        
        /* ë³´ìƒ ì•Œë¦¼ */
        .rewards-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #fcc419;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            z-index: 100;
            animation: slideIn 0.5s forwards;
        }
        
        .rewards-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .best-score {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .new-record {
            color: #e67700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="home-btn" onclick="window.location.href='index.html'">í™ˆ</button>
        <h1>íƒ€ì´í•‘ ë§ˆìŠ¤í„°</h1>
    </div>
    
    <div class="container">
        <div class="difficulty-container" id="difficulty-container">
            <h2>ë‚œì´ë„ ì„ íƒ</h2>
            <p>ì›í•˜ëŠ” ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            <button class="difficulty-btn" onclick="startGame('ì´ˆê¸‰')">ì´ˆê¸‰</button>
            <button class="difficulty-btn" onclick="startGame('ì¤‘ê¸‰')">ì¤‘ê¸‰</button>
            <button class="difficulty-btn" onclick="startGame('ê³ ê¸‰')">ê³ ê¸‰</button>
        </div>
        
        <div class="game-area" id="game-area">
            <div class="score-info">
                <div>ì§„í–‰ë¥ : <span id="progress">0</span>%</div>
                <div class="timer">ì‹œê°„: <span id="time">60</span>ì´ˆ</div>
            </div>
            
            <div class="text-display" id="text-display"></div>
            
            <textarea class="text-input" id="text-input" placeholder="ìœ„ í…ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..." spellcheck="false"></textarea>
            
            <div class="buttons">
                <button class="btn" id="restart-btn">ë‹¤ì‹œ ì‹œì‘</button>
            </div>
        </div>
        
        <div class="result-container" id="result-container">
            <div class="result-title">íƒ€ì´í•‘ ê²°ê³¼</div>
            
            <div class="result-stats">
                <div class="stat-item">
                    <div class="stat-value" id="wpm">0</div>
                    <div class="stat-label">WPM (ë¶„ë‹¹ ë‹¨ì–´ ìˆ˜)</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-value" id="accuracy">0</div>
                    <div class="stat-label">ì •í™•ë„ (%)</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-value" id="time-taken">0</div>
                    <div class="stat-label">ì†Œìš” ì‹œê°„ (ì´ˆ)</div>
                </div>
            </div>
            
            <div class="best-score">ìµœê³  ê¸°ë¡: <span id="best-score">0</span> WPM</div>
            
            <div class="buttons">
                <button class="btn" id="retry-btn">ë‹¤ì‹œ ì‹œë„</button>
                <button class="btn" onclick="window.location.href='index.html'">ë©”ì¸ ë©”ë‰´ë¡œ</button>
                <button class="btn" onclick="window.location.href='rewards.html'">ë³´ìƒ í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <div class="rewards-notification" id="rewards-notification">
        <div class="rewards-icon">ğŸ†</div>
        <div class="rewards-text">ìƒˆë¡œìš´ ë³´ìƒì´ í•´ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    </div>
    
    <footer>
        <p>Â© 2023 êµìœ¡ìš© ì›¹ ê²Œì„ ëª¨ìŒ. ëª¨ë“  ì—°ë ¹ëŒ€ë¥¼ ìœ„í•œ í•™ìŠµ ê²Œì„ì…ë‹ˆë‹¤.</p>
    </footer>

    <!-- Firebase ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
    <script type="module">
        // Firebase êµ¬ì„± íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
        import { auth, currentUser, saveUserDataToCloud, loadUserDataFromCloud } from './firebase-config.js';
        
        // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ ë™ê¸°í™”
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('ì‚¬ìš©ì ë¡œê·¸ì¸ë¨:', user.uid);
                
                // ë¡œê·¸ì¸ëœ ê²½ìš° ìµœê³  ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                const bestScore = await window.gameRewards.getBestScore('typing');
                if (bestScoreElement) {
                    bestScoreElement.textContent = bestScore;
                }
            }
        });
    </script>
    
    <script>
        // ìš”ì†Œ ì„ íƒ
        const difficultyContainer = document.getElementById('difficulty-container');
        const gameArea = document.getElementById('game-area');
        const resultContainer = document.getElementById('result-container');
        const textDisplay = document.getElementById('text-display');
        const textInput = document.getElementById('text-input');
        const progressElement = document.getElementById('progress');
        const timeElement = document.getElementById('time');
        const wpmElement = document.getElementById('wpm');
        const accuracyElement = document.getElementById('accuracy');
        const timeTakenElement = document.getElementById('time-taken');
        const bestScoreElement = document.getElementById('best-score');
        const restartBtn = document.getElementById('restart-btn');
        const retryBtn = document.getElementById('retry-btn');
        const rewardsNotification = document.getElementById('rewards-notification');
        
        // ê²Œì„ ë³€ìˆ˜
        let timer;
        let timeLeft = 60;
        let startTime;
        let endTime;
        let currentText = '';
        let errors = 0;
        let totalTyped = 0;
        let isGameActive = false;
        let currentDifficulty = '';
        let inputHandler; // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¸ì¡°ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
        let bestWpm = 0;
        
        // ë‚œì´ë„ë³„ í…ìŠ¤íŠ¸
        const texts = {
            'ì´ˆê¸‰': [
                "ë‚˜ëŠ” í•™êµì— ê°‘ë‹ˆë‹¤. ì˜¤ëŠ˜ì€ ë‚ ì”¨ê°€ ì¢‹ìŠµë‹ˆë‹¤. ì¹œêµ¬ë“¤ê³¼ ì ì‹¬ì„ ë¨¹ì„ ê²ƒì…ë‹ˆë‹¤.",
                "ì‚¬ê³¼ëŠ” ë¹¨ê°„ìƒ‰ì…ë‹ˆë‹¤. ë°”ë‚˜ë‚˜ëŠ” ë…¸ë€ìƒ‰ì…ë‹ˆë‹¤. í¬ë„ëŠ” ë³´ë¼ìƒ‰ì…ë‹ˆë‹¤. ê³¼ì¼ì€ ë§›ìˆìŠµë‹ˆë‹¤.",
                "ìš°ë¦¬ ê°€ì¡±ì€ ê³µì›ì— ê°”ìŠµë‹ˆë‹¤. ì•„ì´ë“¤ì€ ë†€ì´í„°ì—ì„œ ë†€ì•˜ìŠµë‹ˆë‹¤. ì €ë…ì—ëŠ” ì§‘ì—ì„œ ì˜í™”ë¥¼ ë´¤ìŠµë‹ˆë‹¤.",
                "ì±… ì½ê¸°ëŠ” ì¢‹ì€ ìŠµê´€ì…ë‹ˆë‹¤. ë§¤ì¼ 30ë¶„ì”© ì±…ì„ ì½ìœ¼ë©´ ì§€ì‹ì´ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.",
                "ì£¼ë§ì—ëŠ” ì¹œêµ¬ë“¤ê³¼ ë§Œë‚˜ì„œ ê²Œì„ì„ í•©ë‹ˆë‹¤. ì»´í“¨í„° ê²Œì„ê³¼ ë³´ë“œ ê²Œì„ì„ ì¢‹ì•„í•©ë‹ˆë‹¤."
            ],
            'ì¤‘ê¸‰': [
                "ì½”ë”©ì€ ë…¼ë¦¬ì  ì‚¬ê³ ë¥¼ ê¸°ë¥¼ ìˆ˜ ìˆëŠ” ì¢‹ì€ í™œë™ì…ë‹ˆë‹¤. í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì—ëŠ” ë‹¤ì–‘í•œ ì¢…ë¥˜ê°€ ìˆìœ¼ë©°, ê°ê° íŠ¹ì§•ê³¼ ìš©ë„ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” ì›¹ ê°œë°œì— ë§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.",
                "ê±´ê°•í•œ ìƒí™œì„ ìœ„í•´ì„œëŠ” ê· í˜• ì¡íŒ ì‹ë‹¨ê³¼ ê·œì¹™ì ì¸ ìš´ë™ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. í•˜ë£¨ì— ì ì–´ë„ 30ë¶„ ì´ìƒ ê±·ëŠ” ê²ƒì´ ì¢‹ìœ¼ë©°, ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨ë„ í•„ìˆ˜ì ì…ë‹ˆë‹¤.",
                "ì§€êµ¬ ì˜¨ë‚œí™”ëŠ” í˜„ëŒ€ ì‚¬íšŒì˜ ì‹¬ê°í•œ í™˜ê²½ ë¬¸ì œ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ì´ì‚°í™”íƒ„ì†Œì™€ ê°™ì€ ì˜¨ì‹¤ê°€ìŠ¤ ë°°ì¶œì„ ì¤„ì´ê³ , ì¬ìƒ ì—ë„ˆì§€ ì‚¬ìš©ì„ ëŠ˜ë ¤ì•¼ í•©ë‹ˆë‹¤.",
                "ë…ì„œëŠ” ì§€ì‹ì„ ë„“íˆê³  ìƒìƒë ¥ì„ ê¸°ë¥´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ì¥ë¥´ì˜ ì±…ì„ ì½ìœ¼ë©´ ì„¸ìƒì„ ë³´ëŠ” ì‹œê°ì´ ë„“ì–´ì§€ê³  ì–´íœ˜ë ¥ë„ í–¥ìƒë©ë‹ˆë‹¤.",
                "ì—¬í–‰ì€ ìƒˆë¡œìš´ ë¬¸í™”ì™€ í™˜ê²½ì„ ê²½í—˜í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ê¸°íšŒì…ë‹ˆë‹¤. ì—¬í–‰ ê³„íšì„ ì„¸ìš¸ ë•ŒëŠ” ëª©ì ì§€ì˜ ë‚ ì”¨ì™€ ë¬¸í™”ì  íŠ¹ì§•ì„ ë¯¸ë¦¬ ì¡°ì‚¬í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤."
            ],
            'ê³ ê¸‰': [
                "ì¸ê³µì§€ëŠ¥ ê¸°ìˆ ì˜ ë°œì „ì€ ë‹¤ì–‘í•œ ì‚°ì—… ë¶„ì•¼ì— í˜ëª…ì ì¸ ë³€í™”ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ê³¼ ë”¥ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ì˜ í–¥ìƒìœ¼ë¡œ ì´ë¯¸ì§€ ì¸ì‹, ìì—°ì–´ ì²˜ë¦¬, ì˜ˆì¸¡ ë¶„ì„ ë“±ì˜ ê¸°ëŠ¥ì´ í¬ê²Œ ë°œì „í–ˆìœ¼ë©°, ììœ¨ì£¼í–‰ ìë™ì°¨ë¶€í„° ê°œì¸í™”ëœ ì¶”ì²œ ì‹œìŠ¤í…œê¹Œì§€ ë‹¤ì–‘í•œ ì‘ìš©ì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.",
                "ì§€ì†ê°€ëŠ¥í•œ ë°œì „ì´ë€ ë¯¸ë˜ ì„¸ëŒ€ì˜ í•„ìš”ë¥¼ ì¶©ì¡±ì‹œí‚¬ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì„ ì €í•´í•˜ì§€ ì•Šìœ¼ë©´ì„œ í˜„ ì„¸ëŒ€ì˜ í•„ìš”ë¥¼ ì¶©ì¡±ì‹œí‚¤ëŠ” ë°œì „ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ëŠ” í™˜ê²½ ë³´ì „, ì‚¬íšŒì  í˜•í‰ì„±, ê²½ì œì  ì„±ì¥ì´ë¼ëŠ” ì„¸ ê°€ì§€ ì¸¡ë©´ì„ ê· í˜• ìˆê²Œ ê³ ë ¤í•˜ëŠ” ì ‘ê·¼ ë°©ì‹ìœ¼ë¡œ, ì¥ê¸°ì ìœ¼ë¡œ ëª¨ë“  ìƒëª…ì²´ê°€ ì¡°í™”ë¡­ê²Œ ê³µì¡´í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ë§Œë“œëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.",
                "í˜„ëŒ€ ì‚¬íšŒì—ì„œ ë¹„íŒì  ì‚¬ê³  ëŠ¥ë ¥ì€ ê·¸ ì–´ëŠ ë•Œë³´ë‹¤ ì¤‘ìš”í•´ì¡ŒìŠµë‹ˆë‹¤. ë¬´ìˆ˜í•œ ì •ë³´ê°€ ë„˜ì³ë‚˜ëŠ” ë””ì§€í„¸ ì‹œëŒ€ì— ì •ë³´ì˜ ì‹ ë¢°ì„±ì„ í‰ê°€í•˜ê³ , ë…¼ë¦¬ì  ì˜¤ë¥˜ë¥¼ ì‹ë³„í•˜ë©°, ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¬¸ì œë¥¼ ë°”ë¼ë³¼ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì€ í•„ìˆ˜ì ì…ë‹ˆë‹¤. í•™êµ êµìœ¡ì—ì„œë¶€í„° ì´ëŸ¬í•œ ëŠ¥ë ¥ì„ ê¸°ë¥¼ ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë¨ì„ ê°•í™”í•´ì•¼ í•  í•„ìš”ì„±ì´ ëŒ€ë‘ë˜ê³  ìˆìŠµë‹ˆë‹¤.",
                "ë¬¸í™”ì  ë‹¤ì–‘ì„±ì€ í•œ ì‚¬íšŒì˜ ê°•ì ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì–‘í•œ ë°°ê²½ì„ ê°€ì§„ ì‚¬ëŒë“¤ì´ ì„œë¡œì˜ ê´€ì ê³¼ ê²½í—˜ì„ ê³µìœ í•¨ìœ¼ë¡œì¨ ì°½ì˜ì ì¸ ë¬¸ì œ í•´ê²° ë°©ì•ˆì„ ë„ì¶œí•˜ê³ , í¬ìš©ì ì¸ ì‚¬íšŒë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‹¤ë¬¸í™” êµìœ¡ê³¼ ë¬¸í™” ê°„ ëŒ€í™”ë¥¼ ì´‰ì§„í•˜ëŠ” ì •ì±…ì  ë…¸ë ¥ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.",
                "ë””ì§€í„¸ ë¦¬í„°ëŸ¬ì‹œëŠ” ë””ì§€í„¸ ê¸°ìˆ ì„ íš¨ê³¼ì ìœ¼ë¡œ ì´í•´í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì •ë³´ë¥¼ ë¹„íŒì ìœ¼ë¡œ í‰ê°€í•˜ê³ , ì˜¨ë¼ì¸ ì•ˆì „ì„ ìœ ì§€í•˜ë©°, ë””ì§€í„¸ ë„êµ¬ë¥¼ ì°½ì˜ì ìœ¼ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì€ í˜„ëŒ€ ì‚¬íšŒì—ì„œ ì„±ê³µì ì¸ ì‚¶ì„ ì˜ìœ„í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤. ëª¨ë“  ì—°ë ¹ì¸µì—ê²Œ ë””ì§€í„¸ ë¦¬í„°ëŸ¬ì‹œ êµìœ¡ì˜ ê¸°íšŒë¥¼ ì œê³µí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤."
            ]
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœê³  ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            // ë³´ìƒ ì‹œìŠ¤í…œì´ ìˆëŠ”ì§€ í™•ì¸
            if (window.gameRewards) {
                bestWpm = window.gameRewards.getBestScore('typing');
                bestScoreElement.textContent = bestWpm;
            }
        });
        
        // íƒ€ì´í•‘ ê²€ì‚¬ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜
        function checkTyping() {
            if (!isGameActive) return;
            
            const inputText = textInput.value;
            const originalText = currentText.substring(0, inputText.length);
            
            // ì§„í–‰ë¥  ê³„ì‚°
            const progress = Math.floor((inputText.length / currentText.length) * 100);
            progressElement.textContent = progress;
            
            // ì˜¤íƒ€ ì²´í¬
            let formattedText = '';
            let errorCount = 0;
            
            for (let i = 0; i < inputText.length; i++) {
                if (i >= currentText.length) {
                    errorCount++;
                    break;
                }
                
                if (inputText[i] === currentText[i]) {
                    formattedText += `<span class="completed">${currentText[i]}</span>`;
                } else {
                    formattedText += `<span class="error">${currentText[i]}</span>`;
                    errorCount++;
                }
            }
            
            // ë‚¨ì€ í…ìŠ¤íŠ¸
            if (inputText.length < currentText.length) {
                if (inputText.length < currentText.length - 1) {
                    formattedText += `<span class="highlight">${currentText[inputText.length]}</span>`;
                    formattedText += currentText.substring(inputText.length + 1);
                } else {
                    formattedText += currentText[inputText.length];
                }
            }
            
            textDisplay.innerHTML = formattedText;
            
            // ì˜¤ë¥˜ ì—…ë°ì´íŠ¸
            errors = errorCount;
            totalTyped = inputText.length;
            
            // ì™„ë£Œ í™•ì¸ - ì •í™•íˆ ê°™ì€ì§€ì™€ ê¸¸ì´ê°€ ê°™ì€ì§€ ëª¨ë‘ í™•ì¸
            if (inputText.length === currentText.length && errorCount === 0) {
                endGame();
            }
        }
        
        // ê²Œì„ ì‹œì‘
        function startGame(difficulty) {
            // ëª¨ë“  íƒ€ì´ë¨¸ ì´ˆê¸°í™”ë¥¼ ë¨¼ì € ì‹¤í–‰
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (inputHandler) {
                textInput.removeEventListener('input', inputHandler);
            }
            
            currentDifficulty = difficulty;
            
            // ëœë¤ í…ìŠ¤íŠ¸ ì„ íƒ
            const textArray = texts[difficulty];
            currentText = textArray[Math.floor(Math.random() * textArray.length)];
            
            // í…ìŠ¤íŠ¸ í‘œì‹œ
            textDisplay.innerHTML = currentText;
            
            // ì´ˆê¸°í™”
            textInput.value = '';
            progressElement.textContent = '0';
            timeLeft = 60;
            timeElement.textContent = timeLeft;
            errors = 0;
            totalTyped = 0;
            
            // UI ì „í™˜
            difficultyContainer.style.display = 'none';
            gameArea.style.display = 'block';
            resultContainer.style.display = 'none';
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            startTime = new Date();
            timer = setInterval(() => {
                timeLeft--;
                timeElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            // ê²Œì„ í™œì„±í™”
            isGameActive = true;
            
            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            textInput.focus();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • - ì°¸ì¡° ì €ì¥
            inputHandler = checkTyping;
            textInput.addEventListener('input', inputHandler);
        }
        
        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            if (!isGameActive) return; // ì´ë¯¸ ì¢…ë£Œëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            
            clearInterval(timer);
            timer = null;
            isGameActive = false;
            endTime = new Date();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (inputHandler) {
                textInput.removeEventListener('input', inputHandler);
                inputHandler = null;
            }
            
            // ê²°ê³¼ ê³„ì‚°
            const timeTaken = Math.max(1, Math.round((endTime - startTime) / 1000)); // ìµœì†Œ 1ì´ˆë¡œ ì„¤ì •
            const minutes = timeTaken / 60;
            const wordsCount = currentText.split(' ').length;
            const wpm = Math.round(wordsCount / minutes);
            const accuracy = totalTyped > 0 ? Math.round(((totalTyped - errors) / totalTyped) * 100) : 0;
            
            // ê²°ê³¼ ì—…ë°ì´íŠ¸
            wpmElement.textContent = wpm;
            accuracyElement.textContent = accuracy;
            timeTakenElement.textContent = timeTaken;
            
            // ìµœê³  ì ìˆ˜ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            const isNewRecord = wpm > bestWpm;
            if (isNewRecord) {
                bestWpm = wpm;
                bestScoreElement.textContent = bestWpm;
                bestScoreElement.classList.add('new-record');
            } else {
                bestScoreElement.classList.remove('new-record');
            }
            
            // ë³´ìƒ ì‹œìŠ¤í…œì— ì ìˆ˜ ì—…ë°ì´íŠ¸
            if (window.gameRewards) {
                const newRewards = window.gameRewards.updateScore('typing', wpm);
                if (newRewards) {
                    showRewardsNotification();
                }
            }
            
            // UI ì „í™˜
            gameArea.style.display = 'none';
            resultContainer.style.display = 'block';
        }
        
        // ë³´ìƒ ì•Œë¦¼ í‘œì‹œ
        function showRewardsNotification() {
            rewardsNotification.style.display = 'flex';
            rewardsNotification.style.animation = 'slideIn 0.5s forwards';
            
            setTimeout(() => {
                rewardsNotification.style.animation = 'slideOut 0.5s forwards';
                setTimeout(() => {
                    rewardsNotification.style.display = 'none';
                }, 500);
            }, 3000);
        }
        
        // ì¬ì‹œì‘ ë²„íŠ¼
        restartBtn.addEventListener('click', () => {
            startGame(currentDifficulty);
        });
        
        // ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼
        retryBtn.addEventListener('click', () => {
            difficultyContainer.style.display = 'block';
            resultContainer.style.display = 'none';
        });
    </script>
</body>
</html> 